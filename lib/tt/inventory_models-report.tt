<script>
    $(function() {
        $( "#dateeol" ).datepicker();
        $( "#dateeol_edit" ).datepicker();
    });
</script>

<h3>Inventory Information Based on Model</h3>

<div>
[% IF message.keys.size %]
  [% FOR notification IN message.keys %] 
    [% IF notification == "ERROR" %]
<div class="ui-widget">
   <div class="ui-state-error ui-corner-all" style="margin-top: 20px; padding: 0 .7em;"> 
      <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
           ERROR: [% message.$notification  | html_entity %]
      </p>
   </div>
</div>
    [% ELSE %]
      <p class="input-success">SUCCESS: [% message.$notification | html_entity %]</p>
    [% END %]
  [% END %]
[% END %]


[% IF models.size < 1 %]

<div class="ui-widget">
   <div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;"> 
      <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
           I know of no hardware models at this time. It&#39;s likely none have been entered into the database yet.
      </p>
   </div>
</div>

</div>
[% STOP %]
[% END %]


<div id="rightcolumn">
    <div id="modelgraph" class="graph"></div>
    <div id="hover"></div>

 <h4>Specific Hosts by Model</h4>
    <div id="hosts-bymodel">Select a model above</div>

</div> <!-- right column -->

<div id="middlecolumn">
<!-- summary --> 
[%- livehosts=0 %]
[%- livemodels=0 %]
[%- FOR model IN models -%]
     [%- id = model.id -%]
     [%- count_sum = ( host_counts.$id.active || 0 ) + ( host_counts.$id.inactive || 0 ) + ( host_counts.$id.instock || 0 ) -%]
     [%- NEXT IF  ( host_counts.$id.active || 0 ) < 1 %]
     [%- livemodels = livemodels + 1 %]
     [%- livehosts = livehosts + host_counts.$id.active %]
[%- END -%]

<p>[% livehosts %] active devices, comprised of [% livemodels %] seperate model types.</p>
<!-- end summary -->

<!-- alerts and potential projects -->

<div id="accordion">

    [% INCLUDE inventory_report_modelseolyear.tt %]

    [% INCLUDE inventory_report_modelseol.tt %]
    
    [% INCLUDE inventory_report_modelsnoeol.tt %]
    
</div>

<!-- end alerts -->

<h4>Models Types in Active Use</h4>

<table id="allresults" class="report">
  <thead>
  <tr>
    <th>Model Name</th>
    <th>End of life</th>
    <th>Total Hosts</th>
    <th>Breakdown by Host State<br />Active / Inactive / In stock / Decommissioned</th>
  </tr>
  </thead>

  <tfoot>
    <tr><td colspan="5">There were [% models.size | html_entity %] models returned by the database</td></tr>
  </tfoot>

  [% counter=0 %]
  [% previous_rows_manufacturerid='none' %]
  [%- FOR model IN models -%]
    [%- counter = counter +1 -%]
       [%- id = model.id -%]
       [%- count_sum = ( host_counts.$id.active || 0 ) + ( host_counts.$id.inactive || 0 ) + ( host_counts.$id.instock || 0 ) -%]
       [%- NEXT IF ( host_counts.$id.active || 0 ) < 1 %] 
      
    <tr>
      <td>[% model.manufacturer_name | html_entity %], [% model.name | html_entity %]</td>
      <td>[% model.dateeol | html_entity %]</td>
      <td>[% count_sum | html_entity %]</td>
      <td>
        <span class="status-active">[% (host_counts.$id.active || 0)      | html_entity %] </span> / 
        <span class="status-inactive">[% (host_counts.$id.inactive || 0)  | html_entity %] </span> / 
        <span class="status-instock">[% (host_counts.$id.instock || 0)   | html_entity %] </span> / 
        <span class="status-decommissioned">[% (host_counts.$id.decommissioned || 0) | html_entity %] </span>
      </td>
   </tr>
  [% END %]
</tbody>

</table>
</div> <!-- end middle column -->    

</div> <!-- page end -->

<script type="text/javascript">

$(document).ready(function(){ 
        $("#allresults").tablesorter(
            { 
            headers: { 
               4: { 
                // disable sorting on host status breakdown 
                sorter: false } 
               }, 

           textExtraction:"complex",
        
        }); 
    } 
);

function gethosts(model_name){
   
    var ajax_load="Ajax loading...";

    var loadUrl="[% BASEURL %]/models-hosts?model_name=" + model_name;
    
    $("#host-list").html(ajax_load);  
    $.get(  
        loadUrl, {},  
        function(responseText){  
        
        $("#host-list").html( responseText );  
       }
    );
}

$(function () {
    var data = [

    [%- FOR model IN models -%]
       [%- id = model.id -%]
       [%- count_sum = (host_counts.$id.active||0) + (host_counts.$id.inactive||0) + (host_counts.$id.instock||0) -%]
       { label: "[% model.name | html_entity %]",  data: [% count_sum | html_entity %]},
    [%- END -%]
    ];

$.plot($("#modelgraph"), data, 
{
        series: {
            pie: { 
                show: true,
                // combine results of 2% and less
                combine: {
                    color: '#999',
                    threshold: 0.02
                },
                label: {
                    show: true,
                    radius: 3/4,
                    formatter: function(label, series){
                        return '<div class="graphlabel">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                    },
                    background: { 
                        opacity: 0.5,
                        color: '#000'
                    }
               },
            }
        },
        grid: {
            hoverable: true,
            clickable: true,
        },
        legend: {
            show: false
        }
});
$("#modelgraph").bind("plothover", pieHover);
$("#modelgraph").bind("plotclick", pieClick);

function pieHover(event, pos, obj) {
    if (!obj)
             return;
    percent = parseFloat(obj.series.percent).toFixed(2);
    $("#hover").html('<span style="font-weight: bold;">'+obj.series.label+' ('+percent+'%)</span>');
}

function pieClick(event, pos, obj) {
    if (!obj)
             return;
    gethosts('+obj.series.label+');
}

$(document).ready(function() {
    $("#accordion").accordion({ autoHeight: false });
});

});

</script>
